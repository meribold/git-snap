#!/usr/bin/env bash

snapshot_branch=snapshots-$USER-$HOSTNAME

if ! HEAD=$(git symbolic-ref HEAD); then
   exit
fi

if ! index=$(mktemp); then
   exit
fi

git diff --staged > "$index" || exit

git symbolic-ref HEAD "refs/heads/$snapshot_branch" || exit

# Use a trap to make sure we restore HEAD and the index no matter what.
cleanup() {
   git symbolic-ref HEAD "$HEAD" &&
   # Restore the index.
   git reset -q &&
   if [[ -s $index ]]; then
      # The patch exists and is not empty.  Apply it to the index.
      git apply --cached "$index"
   fi
   rm "$index"
}
trap cleanup EXIT

# This will also commit new files that are already staged.  I think that's good.
git -c advice.statusHints=false commit -uno --no-verify -am 'Snapshot

This is a snapshot commit created using git-snap.

https://github.com/meribold/git-snap'
